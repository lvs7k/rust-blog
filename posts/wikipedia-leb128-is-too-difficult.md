# Wikipediaã®LEB128ã®è¨˜äº‹ãŒé›£ã—ã™ãã‚‹

WebAssemblyã§ã¯æ•´æ•°ã¯LEB128ã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹[^1]ã‚‰ã—ã„ã®ã§ã€LEB128ã¨ã¯ã©ã®ã‚ˆã†ãªã‚‚ã®ãªã®ã‹èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚
ã¾ã¨ã‚‚ãªã‚½ãƒ¼ã‚¹ãŒ[Wikipediaã®è¨˜äº‹](https://en.wikipedia.org/wiki/LEB128)ã—ã‹å­˜åœ¨ã—ãªã„ã®ã«ãã‚ŒãŒç§ã«ã¨ã£ã¦ã¯é›£è§£ã ã£ãŸã®ã§ã€ç†è§£ã—ã‚ˆã†ã¨ã—ãŸéç¨‹ã‚’æ›¸ãæ®‹ã—ã¾ã™ã€‚
æ­£ã—ã„ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚‰ãªã„ã®ã§ã€å‚è€ƒç¨‹åº¦ã«ã—ã¦ãã ã•ã„ã€‚

[^1]: [WebAssembly Specification](https://webassembly.github.io/spec/core/binary/values.html#integers)

**ç›®æ¬¡**
- [ç¬¦å·ãªã—æ•´æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰](#ç¬¦å·ãªã—æ•´æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰)
  - [Wikipediaã®èª¬æ˜1](#wikipediaã®èª¬æ˜1)
  - [ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹1](#ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹1)
  - [ãªãœ128ã‚’è¡¨ç¾ã™ã‚‹ã®ã«2ãƒã‚¤ãƒˆå¿…è¦ãªã®ã‹](#ãªãœ128ã‚’è¡¨ç¾ã™ã‚‹ã®ã«2ãƒã‚¤ãƒˆå¿…è¦ãªã®ã‹)
  - [Rustã‚³ãƒ¼ãƒ‰1](#rustã‚³ãƒ¼ãƒ‰1)
- [ç¬¦å·ãªã—æ•´æ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰](#ç¬¦å·ãªã—æ•´æ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰)
  - [Rustã‚³ãƒ¼ãƒ‰2](#rustã‚³ãƒ¼ãƒ‰2)
- [ç¬¦å·ã‚ã‚Šæ•´æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰](#ç¬¦å·ã‚ã‚Šæ•´æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰)
  - [Wikipediaã®èª¬æ˜2](#wikipediaã®èª¬æ˜2)
  - [ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹2](#ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹2)
  - [ç¬¦å·ã‚ã‚Šã®å ´åˆã®ãƒ“ãƒƒãƒˆãŒ7ã®å€æ•°ã¨ãªã‚‹ã‚ˆã†æ‹¡å¼µã™ã‚‹æ–¹æ³•](#ç¬¦å·ã‚ã‚Šã®å ´åˆã®ãƒ“ãƒƒãƒˆãŒ7ã®å€æ•°ã¨ãªã‚‹ã‚ˆã†æ‹¡å¼µã™ã‚‹æ–¹æ³•)
  - [Rustã‚³ãƒ¼ãƒ‰3](#rustã‚³ãƒ¼ãƒ‰3)
- [ç¬¦å·ã‚ã‚Šæ•´æ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰](#ç¬¦å·ã‚ã‚Šæ•´æ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰)
  - [Rustã‚³ãƒ¼ãƒ‰4](#rustã‚³ãƒ¼ãƒ‰4)
- [è¿½è¨˜ï¼ˆ2025/02/26ï¼‰](#è¿½è¨˜20250226)

## ç¬¦å·ãªã—æ•´æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰

### Wikipediaã®èª¬æ˜1

ç¬¦å·ãªã—æ•´æ•°624485ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒä¾‹ã¨ã—ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«é–¢ã—ã¦ã¯ç‰¹ã«é›£ã—ã„éƒ¨åˆ†ã¯ãªã„ã¨æœ€åˆã«èª­ã‚“ã ã¨ãã¯æ€ã„ã¾ã—ãŸã€‚

```
MSB ------------------ LSB
      10011000011101100101  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
     010011000011101100101  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
 0100110  0001110  1100101  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
00100110 10001110 11100101  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
    0x26     0x8E     0xE5  16é€²æ•°è¡¨ç¾
```

> [!NOTE]
> ã€Œæ•°å€¤ã‚’7ãƒ“ãƒƒãƒˆã®å€æ•°ã«ãªã‚‹ã‚ˆã†ã«ã‚¼ãƒ­æ‹¡å¼µã™ã‚‹ã€ã®éƒ¨åˆ†ã‚’å¾Œã§ã‚‚ã£ã¨è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

### ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹1

ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹ãŒã‚ã‹ã‚‹ã¨ã€ç†è§£ãŒæ·±ã¾ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã—ãŸã€‚
127ã¾ã§ã¯1ãƒã‚¤ãƒˆã€128ã‹ã‚‰ã¯2ãƒã‚¤ãƒˆã«ãªã‚Šã¾ã™ã€‚Wikipediaã®ä¾‹ã®ã‚ˆã†ã«è¡¨ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ç¬¦å·ãªã—æ•´æ•°127ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
MSB ------------------ LSB
                   1111111  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
                   1111111  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
                   1111111  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
                  01111111  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
                      0x7F  16é€²æ•°è¡¨ç¾
```

ç¬¦å·ãªã—æ•´æ•°128ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
MSB ------------------ LSB
                  10000000  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
            00000010000000  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
          0000001  0000000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
         00000001 10000000  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
             0x01     0x80  16é€²æ•°è¡¨ç¾
```

### ãªãœ128ã‚’è¡¨ç¾ã™ã‚‹ã®ã«2ãƒã‚¤ãƒˆå¿…è¦ãªã®ã‹

128ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¾‹ã«ãŠã„ã¦ã€7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²ã—ãŸä¸€ç•ªå³ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã«0ã‚’ã¤ã‘ã¦ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰çµæœã‚’0x00ã¨ã—ãŸã¨ã—ã¾ã™ã€‚
ã“ã‚Œã¯0ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã¨åŒã˜ã«ãªã£ã¦ã—ã¾ã„ãƒ‡ã‚³ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚

### Rustã‚³ãƒ¼ãƒ‰1

Wikipediaã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«ã€Rustã§u32ã‚’LEB128ã¸ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°ã‚’æ›¸ãã¾ã—ãŸã€‚

```rust
pub fn to_leb128_u32(mut value: u32) -> Vec<u8> {
    let mut result = Vec::new();

    loop {
        let byte = (value & 0b01111111) as u8;
        value >>= 7;

        if value == 0 {
            result.push(byte);
            break;
        }

        result.push(byte | 0b10000000);
    }

    result
}
```

æ•´æ•°128ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã¨ãã®å‹•ä½œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã“ã†ãªã‚Šã¾ã™ã€‚

```
value: 00000000000000000000000010000000

ãƒ«ãƒ¼ãƒ—1
byte: 00000000
value: 00000000000000000000000000000001
value == 0 -> false
result: [10000000]

ãƒ«ãƒ¼ãƒ—2
byte: 00000001
value: 00000000000000000000000000000000
value == 0 -> true
result: [10000000, 00000001]
break

result: [10000000, 00000001]
```

Wikipediaã®èª¬æ˜ã§ã¯ã€Œ7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µã—ã¦ã‹ã‚‰åˆ†å‰²ã€ã¨ãªã£ã¦ã„ã¾ã™ãŒã€ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã§ã¯ä¸‹ä½7ãƒ“ãƒƒãƒˆã‚’å–ã‚Šå‡ºã—ãªãŒã‚‰çµæœã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚


## ç¬¦å·ãªã—æ•´æ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰

ã€Œ7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²ã—ãŸã‚‚ã®ã‚’ãƒã‚¤ãƒˆåˆ—ã«ã—ãŸã®ã ã‹ã‚‰ã€é€†ã«ãƒã‚¤ãƒˆåˆ—ã‹ã‚‰ä¸‹ä½7ãƒ“ãƒƒãƒˆã‚’å–ã‚Šå‡ºã—ã¦çµåˆã™ã‚Œã°ã„ã„ã‚ˆã­ã€ã¨ã„ã†æ–¹é‡ã§ã€Wikipediaã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

### Rustã‚³ãƒ¼ãƒ‰2

```rust
pub fn from_leb128_u32(input: &[u8]) -> Result<u32, String> {
    let mut result: u128 = 0;
    let mut shift: usize = 0;
    let size: usize = std::mem::size_of_val(&result) * 8;

    for &byte in input {
        result |= ((byte & 0b01111111) as u128) << shift;
        shift += 7;

        if shift >= size {
            return Err("byte sequence too long".into());
        }

        if byte & 0b10000000 == 0 {
            break;
        }
    }

    u32::try_from(result).map_err(|e| e.to_string())
}
```

æ•´æ•°128ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸã¨ãã®å‹•ä½œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã“ã†ãªã‚Šã¾ã™ã€‚

```
input: [10000000, 00000001]
result: 00000000000000000000000000000000

ãƒ«ãƒ¼ãƒ—1
byte & 0b01111111: 00000000
result: 00000000000000000000000000000000
shift: 7
byte & 0b10000000 == 0 -> false

ãƒ«ãƒ¼ãƒ—2
byte & 0b01111111: 00000001
result: 00000000000000000000000010000000
shift: 14
byte & 0b10000000 == 0 -> true
break

result: 00000000000000000000000010000000
```

ãƒ“ãƒƒãƒˆã‚’æ“ä½œã—ã¦æœ€çµ‚çš„ãªçµæœã‚’è¿”ã™`result`ã®å‹ã‚’`u128`ã«ã—ã¦ã„ã¾ã™ã€‚
ä¸Šã®ä¾‹ã®ã‚ˆã†ã«æ•´æ•°128ã¯LEB128ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨2ãƒã‚¤ãƒˆã«ãªã‚Šã¾ã™ãŒã€ã‚‚ã—`result`ã®å‹ãŒ`u8`ã ã£ãŸã¨ã™ã‚‹ã¨7ãƒ“ãƒƒãƒˆã‚’2ã¤çµåˆã—ã¦14ãƒ“ãƒƒãƒˆã¨ãªã‚Š8ã‚’è¶…ãˆã¦ã—ã¾ã„ã¾ã™ã€‚
ä½œæ¥­ã‚¹ãƒšãƒ¼ã‚¹ã¨ã—ã¦å¤§ãã„`u128`ã‚’ä½¿ç”¨ã—ã¦ã€æœ€å¾Œã«`try_from`ã§å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚

## ç¬¦å·ã‚ã‚Šæ•´æ•°ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰

### Wikipediaã®èª¬æ˜2

ç¬¦å·ã‚ã‚Šæ•´æ•°-123456ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒä¾‹ã¨ã—ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒã‚ã‹ã‚Šã¥ã‚‰ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚-123456ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã®ã«ã€é–‹å§‹åœ°ç‚¹ãŒ123456ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

```
MSB ------------------ LSB
         11110001001000000  123456 ã®2é€²æ•°è¡¨ç¾
     000011110001001000000  21ãƒ“ãƒƒãƒˆã®
     111100001110110111111  ã™ã¹ã¦ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ (1ã®è£œæ•°)
     111100001110111000000  1ã‚’è¶³ã™(2ã®è£œæ•°)
 1111000  0111011  1000000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
01111000 10111011 11000000  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
    0x78     0xBB     0xC0  16é€²æ•°è¡¨ç¾
```

ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã¯-123456ã®ã‚ˆã†ãªè² ã®å€¤ã‚‚ãã®ã¾ã¾å‡¦ç†ã‚’ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚-123456ã‚’2ã®è£œæ•°ã¨ã—ã¦2é€²æ•°ã§è¡¨ç¾ã—ãŸã‚‚ã®ã‚’é–‹å§‹åœ°ç‚¹ã¨ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœãŒã©ã“ã§1ãƒã‚¤ãƒˆã‹ã‚‰2ãƒã‚¤ãƒˆã«å¢—ãˆã‚‹ã‹2

æ­£ã®æ•°ã®å ´åˆã¯63ã¾ã§ã¯1ãƒã‚¤ãƒˆã€64ã‹ã‚‰ã¯2ãƒã‚¤ãƒˆã«ãªã‚Šã¾ã™ã€‚è² ã®æ•°ã®å ´åˆã¯-64ã¾ã§ã¯1ãƒã‚¤ãƒˆã€-65ã‹ã‚‰ã¯2ãƒã‚¤ãƒˆã«ãªã‚Šã¾ã™ã€‚Wikipediaã®ä¾‹ã®ã‚ˆã†ã«è¡¨ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ç¬¦å·ã‚ã‚Šæ•´æ•°63ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
MSB ------------------ LSB
                   0111111  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
                   0111111  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
                   0111111  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
                  00111111  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
                      0x3F  16é€²æ•°è¡¨ç¾
```

ç¬¦å·ã‚ã‚Šæ•´æ•°64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆèª¤ã‚Šï¼‰
```
MSB ------------------ LSB
                   1000000  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
                   1000000  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
                   100000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
                  01000000  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
                      0x40  16é€²æ•°è¡¨ç¾
```

> [!CAUTION]
> ä¸Šè¨˜ã®ç¬¦å·ã‚ã‚Šæ•´æ•°64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¯èª¤ã‚Šã§ã™ã€‚

Wikipediaã®èª¬æ˜é€šã‚Šã«ã‚„ã£ã¦ã„ã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€ãªãœèª¤ã‚Šãªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿå…ˆã«-64ã¨-65ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ç¬¦å·ã‚ã‚Šæ•´æ•°-64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
MSB ------------------ LSB
                   1000000  64 ã®2é€²æ•°è¡¨ç¾
                   1000000  7ãƒ“ãƒƒãƒˆã®
                   0111111  ã™ã¹ã¦ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ (1ã®è£œæ•°)
                   1000000  1ã‚’è¶³ã™(2ã®è£œæ•°)
                   1000000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
                  01000000  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
                      0x40  16é€²æ•°è¡¨ç¾
```

ç¬¦å·ã‚ã‚Šæ•´æ•°-65ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆèª¤ã‚Šï¼‰
```
MSB ------------------ LSB
                   1000001  65 ã®2é€²æ•°è¡¨ç¾
                   1000001  7ãƒ“ãƒƒãƒˆã®
                   0111110  ã™ã¹ã¦ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ (1ã®è£œæ•°)
                   0111111  1ã‚’è¶³ã™(2ã®è£œæ•°)
                   0111111  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
                  00111111  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
                      0x3F  16é€²æ•°è¡¨ç¾
```

> [!CAUTION]
> ä¸Šè¨˜ã®ç¬¦å·ã‚ã‚Šæ•´æ•°-65ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¯èª¤ã‚Šã§ã™ã€‚

63ã¨-65ã€64ã¨-64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰çµæœãŒåŒã˜ã¨ãªã‚Šè¦‹åˆ†ã‘ãŒã¤ã‹ãªããªã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½ã£ã¦ã¿ã‚‹ã¨ã€64ã¨-65ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚‹ã®ãŒæ­£ã—ãã†ã§ã™ã€‚

ç¬¦å·ã‚ã‚Šæ•´æ•°64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
MSB ------------------ LSB
                   1000000  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
            00000001000000  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
          0000000  1000000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
         00000000 11000000  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
             0x00     0xC0  16é€²æ•°è¡¨ç¾
```

ç¬¦å·ã‚ã‚Šæ•´æ•°-65ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```
MSB ------------------ LSB
                   1000001  65 ã®2é€²æ•°è¡¨ç¾
            00000001000001  14ãƒ“ãƒƒãƒˆã®
            11111110111110  ã™ã¹ã¦ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ (1ã®è£œæ•°)
            11111110111111  1ã‚’è¶³ã™(2ã®è£œæ•°)
          1111111  0111111  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
         01111111 10111111  æœ€å¾Œï¼ˆæœ€ä¸Šä½ï¼‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤ãã™ã¹ã¦ã«é«˜ä½1ãƒ“ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãƒã‚¤ãƒˆã‚’å½¢æˆ
             0x7F     0xBF  16é€²æ•°è¡¨ç¾
```

Wikipediaã®ç¬¦å·ãªã—LEB128ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ãªæ–‡ãŒã‚ã‚Šã¾ã™ã€‚
> æ¬¡ã«æ•°å€¤ã‚’7ãƒ“ãƒƒãƒˆã®å€æ•°ã«ãªã‚‹ã‚ˆã†ã«ã‚¼ãƒ­æ‹¡å¼µã™ã‚‹ï¼ˆæ•°å€¤ãŒ0ã§ãªã„å ´åˆã€æœ€ä¸Šä½7ãƒ“ãƒƒãƒˆãŒã™ã¹ã¦0ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰ã€‚

ä¸Šã®64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯æœ€ä¸Šä½7ãƒ“ãƒƒãƒˆãŒã™ã¹ã¦0ã«ãªã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã®æ‹¡å¼µã¯å•é¡Œãªã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### ç¬¦å·ã‚ã‚Šã®å ´åˆã®ãƒ“ãƒƒãƒˆãŒ7ã®å€æ•°ã¨ãªã‚‹ã‚ˆã†æ‹¡å¼µã™ã‚‹æ–¹æ³•

> [!WARNING]
> é–“é•ã£ãŸã“ã¨ã‚’è¨€ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§å‚è€ƒç¨‹åº¦ã«ã—ã¦ãã ã•ã„ã€‚

æ­£ã®æ•°ã®å ´åˆã®æ‹¡å¼µï¼ˆä¾‹ï¼šç¬¦å·ã‚ã‚Šæ•´æ•°63ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
```
MSB ------------------ LSB
                   0111111  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
                   0111111  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
                   0111111  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
```

æ­£ã®æ•°ã®å ´åˆã®æ‹¡å¼µï¼ˆä¾‹ï¼šç¬¦å·ã‚ã‚Šæ•´æ•°64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
```
MSB ------------------ LSB
                   1000000  å…ƒã®å€¤ã®2é€²æ•°è¡¨ç¾
            00000001000000  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
          0000000  1000000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
```

ç¬¦å·ã‚ã‚Šæ•´æ•°ã§æ­£ã®æ•°ã®å ´åˆã¯ä¸Šä½ãƒ“ãƒƒãƒˆã«0ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§æ‹¡å¼µã—ã¾ã™ã€‚æœ€ä¸Šä½7ãƒ“ãƒƒãƒˆãŒã™ã¹ã¦0ã«ãªã£ãŸã¨ã—ã¦ã‚‚ã€æ¬¡ã®7ãƒ“ãƒƒãƒˆã®å…ˆé ­ã®ãƒ“ãƒƒãƒˆãŒ1ãªã‚‰ã°æ‹¡å¼µã—ã¦ã‚ˆã„ã§ã™ã€‚

è² ã®æ•°ã®å ´åˆã®æ‹¡å¼µï¼ˆä¾‹ï¼šç¬¦å·ã‚ã‚Šæ•´æ•°-64ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
```
MSB ------------------ LSB
                   1000000  -64ã®2é€²æ•°è¡¨ç¾(2ã®è£œæ•°)
                   1000000  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
                   1000000  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
```

è² ã®æ•°ã®å ´åˆã®æ‹¡å¼µï¼ˆä¾‹ï¼šç¬¦å·ã‚ã‚Šæ•´æ•°-65ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
```
MSB ------------------ LSB
                  10111111  -65ã®2é€²æ•°è¡¨ç¾(2ã®è£œæ•°)
            11111110111111  7ã®å€æ•°ãƒ“ãƒƒãƒˆã«æ‹¡å¼µ
          1111111  0111111  7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²
```

ç¬¦å·ã‚ã‚Šæ•´æ•°ã§æ­£ã®æ•°ã®å ´åˆã¯ä¸Šä½ãƒ“ãƒƒãƒˆã«1ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§æ‹¡å¼µã—ã¾ã™ã€‚æœ€ä¸Šä½7ãƒ“ãƒƒãƒˆãŒã™ã¹ã¦1ã«ãªã£ãŸã¨ã—ã¦ã‚‚ã€æ¬¡ã®7ãƒ“ãƒƒãƒˆã®å…ˆé ­ã®ãƒ“ãƒƒãƒˆãŒ0ãªã‚‰ã°æ‹¡å¼µã—ã¦ã‚ˆã„ã§ã™ã€‚

### Rustã‚³ãƒ¼ãƒ‰3

Wikipediaã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«ã€Rustã§i32ã‚’LEB128ã¸ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°ã‚’æ›¸ãã¾ã—ãŸã€‚

```rust
pub fn to_leb128_i32(mut value: i32) -> Vec<u8> {
    let mut result = Vec::new();

    loop {
        let byte = (value & 0b01111111) as u8;
        value >>= 7;

        if value == 0 && (byte & 0b01000000) == 0 || value == -1 && (byte & 0b01000000) != 0 {
            result.push(byte);
            break;
        }

        result.push(byte | 0b10000000);
    }

    result
}
```

> [!NOTE]
> Rustã®å³ã‚·ãƒ•ãƒˆæ¼”ç®—å­`>>`ã¯arithmetic shiftã§ã™ã€‚è² ã®æ•°ã‚’å³ã‚·ãƒ•ãƒˆã™ã‚‹ã¨ã€ä¸Šä½ãƒ“ãƒƒãƒˆã«ã¯1ãŒå…¥ã‚Šã¾ã™ã€‚
> [The Rust Reference](https://doc.rust-lang.org/reference/expressions/operator-expr.html?highlight=arithmetic%20shift#arithmetic-and-logical-binary-operators)

ã»ã¼ç¬¦å·ãªã—æ•´æ•°ã®ã¨ãã¨åŒã˜ã§ã™ã€‚ãƒ«ãƒ¼ãƒ—ã®çµ‚äº†æ¡ä»¶ãŒç•°ãªã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
ç›´æ„Ÿçš„ãªèª¬æ˜ã‚’ã™ã‚‹ã¨ã€valueã‚’å³ã‚·ãƒ•ãƒˆã—ã¦ã„ã£ã¦ãƒ“ãƒƒãƒˆãŒå…¨ã¦1ï¼ˆã¤ã¾ã‚Šå€¤ãŒ-1ï¼‰ã¨ãªã£ãŸã¨ãã€ç›´å‰ã«å–ã‚Šå‡ºã—ãŸ7ãƒ“ãƒƒãƒˆã®å…ˆé ­ãƒ“ãƒƒãƒˆãŒ1ãªã‚‰ã°ãƒ«ãƒ¼ãƒ—ã‚’çµ‚äº†ã—ã€0ãªã‚‰ã°å†åº¦ãƒ«ãƒ¼ãƒ—ã—ã¾ã™ã€‚
ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯[ç¬¦å·ã‚ã‚Šã®å ´åˆã®ãƒ“ãƒƒãƒˆãŒ7ã®å€æ•°ã¨ãªã‚‹ã‚ˆã†æ‹¡å¼µã™ã‚‹æ–¹æ³•](#ç¬¦å·ã‚ã‚Šã®å ´åˆã®ãƒ“ãƒƒãƒˆãŒ7ã®å€æ•°ã¨ãªã‚‹ã‚ˆã†æ‹¡å¼µã™ã‚‹æ–¹æ³•)ã¨åŒã˜ã§ã™ã€‚

## ç¬¦å·ã‚ã‚Šæ•´æ•°ã®ãƒ‡ã‚³ãƒ¼ãƒ‰

ã€Œ7ãƒ“ãƒƒãƒˆã”ã¨ã«åˆ†å‰²ã—ãŸã‚‚ã®ã‚’ãƒã‚¤ãƒˆåˆ—ã«ã—ãŸã®ã ã‹ã‚‰ã€é€†ã«ãƒã‚¤ãƒˆåˆ—ã‹ã‚‰ä¸‹ä½7ãƒ“ãƒƒãƒˆã‚’å–ã‚Šå‡ºã—ã¦çµåˆã™ã‚Œã°ã„ã„ã‚ˆã­ã€ã¨ã„ã†æ–¹é‡ã¯ã€ç¬¦å·ãªã—ã®ã¨ãã¨å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚


### Rustã‚³ãƒ¼ãƒ‰4

```rust
pub fn from_leb128_i32(input: &[u8]) -> Result<i32, String> {
    let mut result: i128 = 0;
    let mut shift: usize = 0;
    let size: usize = std::mem::size_of_val(&result) * 8;

    for &byte in input {
        result |= ((byte & 0b01111111) as i128) << shift;
        shift += 7;

        if shift >= size {
            return Err("byte sequence too long".into());
        }

        if byte & 0b10000000 == 0 {
            if byte & 0b01000000 != 0 {
                result |= !0 << shift;
            }
            break;
        }
    }

    i32::try_from(result).map_err(|e| e.to_string())
}
```

é•ã„ã¯ä¸‹è¨˜ã®éƒ¨åˆ†ã§ã™ã€‚

```rust
        if byte & 0b10000000 == 0 {
            if byte & 0b01000000 != 0 {
                result |= !0 << shift;
            }
            break;
        }
```

`if byte & 0b10000000 == 0`ã¯å…ˆé ­ãƒ“ãƒƒãƒˆãŒ0ãªã®ã§ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸçµæœã®æœ€å¾Œã®ãƒã‚¤ãƒˆã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
æ¬¡ã®`if byte & 0b01000000 != 0`ã§ã¯æœ€å¾Œã®ãƒã‚¤ãƒˆã®ä¸Šã‹ã‚‰2æ¡ç›®ã®ãƒã‚¤ãƒˆãŒ1ã‹ã©ã†ã‹ã€ã¤ã¾ã‚Šè² ã®æ•°ã§ã‚ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚
è² ã§ã‚ã‚‹å ´åˆã€`result |= !0 << shift;`ã®éƒ¨åˆ†ã§çµæœã®ä¸Šä½ãƒ“ãƒƒãƒˆã‚’1ã§åŸ‹ã‚å°½ãã—ã¦è² ã®æ•°ã«ã—ã¦ã„ã¾ã™ã€‚

> [!NOTE]
> `!`ã¯ãƒ“ãƒƒãƒˆåè»¢æ¼”ç®—å­ã§ã™ã€‚Cè¨€èªã§ã¯`~`ã§ã™ãŒã€Rustã§ã¯`!`ã§ã™ã€‚ã“ã“ã§ã¯`0`ã‚’åè»¢ã—ã¦`11111111...`ã¨ã„ã†ãƒ“ãƒƒãƒˆåˆ—ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

## è¿½è¨˜ï¼ˆ2025/02/26ï¼‰

ä»–ã®äººã®å®Ÿè£…ã‚’è¦‹ã‚‹ã¨ã€ã‚„ã£ã±ã‚Šã‚‚ã£ã¨ã‚¹ãƒãƒ¼ãƒˆãªã‚„ã‚Šæ–¹ã‚’ã—ã¦ã¾ã™ã­ğŸ’¦ç§ãŒæ›¸ã„ãŸæœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã¯[lvs7k/leb128-rs](https://github.com/lvs7k/leb128-rs/)ã«ä¿å­˜ã—ã¦ãŠãã¾ã™ã€‚
